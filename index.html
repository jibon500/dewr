<!-- admin-panel.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Earning App</title>
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #0d47a1;
            --success-color: #34a853;
            --warning-color: #f9ab00;
            --danger-color: #ea4335;
            --light-bg: #f8f9fa;
            --dark-bg: #202124;
            --card-bg: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
        }

        body.dark-mode {
            --light-bg: #202124;
            --dark-bg: #000000;
            --card-bg: #303134;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #5f6368;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            background-color: var(--light-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--card-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); }

        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #d93025; }

        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #2d8644; }

        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-warning:hover { background-color: #e89a00; }

        .btn-secondary { background-color: #5f6368; color: white; }
        .btn-secondary:hover { background-color: #444746; }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.3em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--light-bg);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(0,0,0,0.05);
        }

        body.dark-mode tr:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-pending { background-color: rgba(249, 171, 0, 0.2); color: var(--warning-color); }
        .status-approved { background-color: rgba(52, 168, 83, 0.2); color: var(--success-color); }
        .status-rejected { background-color: rgba(234, 67, 53, 0.2); color: var(--danger-color); }
        .status-blocked { background-color: rgba(234, 67, 53, 0.2); color: var(--danger-color); }
        .status-active { background-color: rgba(52, 168, 83, 0.2); color: var(--success-color); }

        .action-cell {
            display: flex;
            gap: 5px;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1002;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }

        nav li {
            margin: 0;
        }

        nav button {
            background-color: var(--light-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
        }

        nav button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        nav button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .user-info {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .dark-mode-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Admin Dashboard - Earning App</h1>
            <div class="controls">
                <span class="user-info">Admin: <span id="adminUidDisplay">Loading...</span></span>
                <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">ðŸŒ™</button>
                <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
        </header>

        <nav>
            <ul>
                <li><button class="nav-btn active" data-target="dashboard">Dashboard</button></li>
                <li><button class="nav-btn" data-target="users">Users</button></li>
                <li><button class="nav-btn" data-target="withdrawals">Withdrawals</button></li>
                <li><button class="nav-btn" data-target="referrals">Referrals</button></li>
                <li><button class="nav-btn" data-target="settings">Settings</button></li>
            </ul>
        </nav>

        <div id="toast" class="toast"></div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="card">
                <h2>Quick Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="statTotalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Ad Views</div>
                        <div class="stat-value" id="statTotalAdViews">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Referrals</div>
                        <div class="stat-value" id="statTotalReferrals">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Earnings (USDT)</div>
                        <div class="stat-value" id="statTotalEarnings">0.0000</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Withdrawals</div>
                        <div class="stat-value" id="statTotalWithdrawals">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="section">
            <div class="card">
                <h2>User Management</h2>
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Balance (USDT)</th>
                            <th>Last Active</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Withdrawals Section -->
        <div id="withdrawals" class="section">
            <div class="card">
                <h2>Withdrawal Requests</h2>
                <table id="withdrawalsTable">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Request ID</th>
                            <th>Amount (USDT)</th>
                            <th>Method</th>
                            <th>Address</th>
                            <th>Timestamp</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8">Loading requests...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Referrals Section -->
        <div id="referrals" class="section">
            <div class="card">
                <h2>Referral Bonuses</h2>
                <table id="referralsTable">
                    <thead>
                        <tr>
                            <th>Referrer ID</th>
                            <th>Referee ID</th>
                            <th>Amount (USDT)</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4">Loading referrals...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="card">
                <h2>App Settings</h2>
                 <div class="form-group">
                    <label for="monetagRewardPerTask">Reward Per Monetag Ad View (USDT):</label>
                    <input type="number" id="monetagRewardPerTask" step="0.0001" min="0" placeholder="e.g., 0.0001">
                </div>
                 <div class="form-group">
                    <label for="minimumWithdrawalAmount">Minimum Withdrawal Amount (USDT):</label>
                    <input type="number" id="minimumWithdrawalAmount" step="0.01" min="0" placeholder="e.g., 5.00">
                </div>
                 <div class="form-group">
                    <label for="userDailyTaskLimit">User Daily Task Limit (Per User):</label>
                    <input type="number" id="userDailyTaskLimit" min="0" placeholder="e.g., 1000">
                </div>
                <div class="form-group">
                    <label for="monetagAdZoneId">Monetag Ad Zone ID:</label>
                    <input type="text" id="monetagAdZoneId" placeholder="e.g., 9344336">
                </div>
                <div class="form-group">
                    <label for="adminMessage">Admin Message (Marquee in User App):</label>
                    <textarea id="adminMessage" rows="3" placeholder="Enter important message for users..."></textarea>
                </div>
                <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                <button class="btn btn-danger" id="deleteAdminMessageBtn" style="margin-left: 10px;">Delete Message</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- Firebase Config (MUST match your user app config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD3BGZ0MVLpbQbIpLUAnYvWNEIyk7Y6S0Q",
            authDomain: "earning-app-80258.firebaseapp.com",
            databaseURL: "https://earning-app-80258-default-rtdb.firebaseio.com",
            projectId: "earning-app-80258",
            storageBucket: "earning-app-80258.appspot.com",
            messagingSenderId: "25930019210",
            appId: "1:25930019210:web:6441562811d3e7e9631873"
        };

        // --- ADMIN CONFIGURATION ---
        const ADMIN_UID = "YOUR_ADMIN_UID_HERE"; // <-- REPLACE WITH YOUR ACTUAL ADMIN UID

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // --- DOM Elements ---
        const toastElement = document.getElementById('toast');
        const logoutBtn = document.getElementById('logoutBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const adminUidDisplay = document.getElementById('adminUidDisplay');
        const navButtons = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.section');

        // --- State ---
        let currentAdminUid = null;

        // --- Utility Functions ---
        function showToast(message, isError = false) {
            toastElement.textContent = message;
            toastElement.className = 'toast show';
            if (isError) toastElement.style.backgroundColor = '#ea4335';
            else toastElement.style.backgroundColor = '#333';
            setTimeout(() => { toastElement.className = toastElement.className.replace('show', ''); }, 3000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function setActiveSection(targetId) {
            sections.forEach(section => section.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            document.querySelector(`.nav-btn[data-target="${targetId}"]`).classList.add('active');
        }

        function formatTimestamp(timestampStr) {
            if (!timestampStr) return 'N/A';
            const date = new Date(timestampStr);
            return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleString();
        }

        function loadSettings() {
            const appSettingsRef = database.ref('appSettings');
            appSettingsRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('monetagRewardPerTask').value = data.rewardPerTaskUSD || '';
                    document.getElementById('minimumWithdrawalAmount').value = data.minimumWithdrawalAmount || '';
                    document.getElementById('userDailyTaskLimit').value = data.dailyTaskLimit || '';
                    document.getElementById('monetagAdZoneId').value = data.adZoneId || '';
                }
            }).catch(err => {
                console.error("Error loading app settings:", err);
                showToast("Failed to load settings.", true);
            });

            const adminMessageRef = database.ref('adminMessage');
            adminMessageRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && data.text) {
                    document.getElementById('adminMessage').value = data.text;
                }
            }).catch(err => {
                console.error("Error loading admin message:", err);
                showToast("Failed to load admin message.", true);
            });
        }

        function saveSettings() {
             const rewardPerTask = parseFloat(document.getElementById('monetagRewardPerTask').value);
             const minWithdrawal = parseFloat(document.getElementById('minimumWithdrawalAmount').value);
             const dailyLimit = parseInt(document.getElementById('userDailyTaskLimit').value, 10);
            const adZoneId = document.getElementById('monetagAdZoneId').value.trim();
            const adminMsg = document.getElementById('adminMessage').value.trim();

            const updates = {};

             if (!isNaN(rewardPerTask) && rewardPerTask >= 0) {
                 updates['appSettings/rewardPerTaskUSD'] = rewardPerTask;
             }
             if (!isNaN(minWithdrawal) && minWithdrawal >= 0) {
                 updates['appSettings/minimumWithdrawalAmount'] = minWithdrawal;
             }
            if (!isNaN(dailyLimit)) {
                updates['appSettings/dailyTaskLimit'] = dailyLimit;
            }
            if (adZoneId) {
                updates['appSettings/adZoneId'] = adZoneId;
            }
            updates['adminMessage/text'] = adminMsg || "";

            database.ref().update(updates)
                .then(() => {
                    showToast("Settings saved successfully!");
                    loadSettings();
                })
                .catch(err => {
                    console.error("Error saving settings:", err);
                    showToast("Failed to save settings.", true);
                });
        }

        function deleteAdminMessage() {
            if (confirm("Are you sure you want to delete the admin message?")) {
                database.ref('adminMessage/text').set("")
                    .then(() => {
                        showToast("Admin message deleted.");
                        document.getElementById('adminMessage').value = "";
                    })
                    .catch(err => {
                        console.error("Error deleting admin message:", err);
                        showToast("Failed to delete message.", true);
                    });
            }
        }

        // --- Data Loading Functions ---
        function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '<tr><td colspan="7">Loading users...</td></tr>';

            database.ref('users').once('value')
                .then(snapshot => {
                    tbody.innerHTML = '';
                    const users = snapshot.val();
                    if (!users) {
                        tbody.innerHTML = '<tr><td colspan="7">No users found.</td></tr>';
                        return;
                    }

                    Object.entries(users).forEach(([userId, userData]) => {
                        const row = document.createElement('tr');
                        // Use strict boolean check for isBlocked
                        const isBlocked = userData.isBlocked === true;
                        const statusText = isBlocked ? 'Blocked' : 'Active';
                        const statusClass = isBlocked ? 'status-blocked' : 'status-active';

                        row.innerHTML = `
                            <td>${userId}</td>
                            <td>${userData.telegramUser?.name || 'N/A'}</td>
                            <td>${userData.telegramUser?.phoneNumber || 'N/A'}</td>
                            <td>${parseFloat(userData.userUSDTBalance || 0).toFixed(4)}</td>
                            <td>${formatTimestamp(userData.lastSeen)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="action-cell">
                                <button class="btn ${isBlocked ? 'btn-success' : 'btn-danger'} toggle-block-btn"
                                        data-user-id="${userId}" data-blocked="${isBlocked}">
                                    ${isBlocked ? 'Unblock' : 'Block'}
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Add event listeners to block/unblock buttons
                    document.querySelectorAll('.toggle-block-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.getAttribute('data-user-id');
                            // Use strict boolean check for data-blocked attribute
                            const isCurrentlyBlocked = this.getAttribute('data-blocked') === 'true';
                            toggleUserBlock(userId, !isCurrentlyBlocked);
                        });
                    });

                })
                .catch(err => {
                    console.error("Error loading users:", err);
                    tbody.innerHTML = `<tr><td colspan="7">Error loading users: ${err.message}</td></tr>`;
                    showToast("Failed to load users.", true);
                });
        }

        function loadWithdrawals() {
            const tbody = document.querySelector('#withdrawalsTable tbody');
            tbody.innerHTML = '<tr><td colspan="8">Loading requests...</td></tr>';

            database.ref('withdrawals').once('value')
                .then(snapshot => {
                    tbody.innerHTML = '';
                    const allWithdrawals = [];

                    snapshot.forEach(userSnapshot => {
                        const userId = userSnapshot.key;
                        userSnapshot.forEach(requestSnapshot => {
                            const requestId = requestSnapshot.key;
                            const requestData = requestSnapshot.val();
                            allWithdrawals.push({ userId, requestId, ...requestData });
                        });
                    });

                    if (allWithdrawals.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8">No withdrawal requests found.</td></tr>';
                        return;
                    }

                    allWithdrawals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    allWithdrawals.forEach(request => {
                         const statusClass = `status-${request.status || 'pending'}`;
                         const statusText = request.status ? request.status.charAt(0).toUpperCase() + request.status.slice(1) : 'Pending';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${request.userId}</td>
                            <td>${request.requestId}</td>
                            <td>${parseFloat(request.amount || 0).toFixed(4)}</td>
                            <td>${request.method || 'N/A'}</td>
                            <td>${request.address || 'N/A'}</td>
                            <td>${formatTimestamp(request.timestamp)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="action-cell">
                                <select class="status-select" data-user-id="${request.userId}" data-request-id="${request.requestId}">
                                    <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="approved" ${request.status === 'approved' ? 'selected' : ''}>Approved</option>
                                    <option value="rejected" ${request.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                                <button class="btn btn-primary update-status-btn" data-user-id="${request.userId}" data-request-id="${request.requestId}">Update</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    document.querySelectorAll('.update-status-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                             const userId = this.getAttribute('data-user-id');
                             const requestId = this.getAttribute('data-request-id');
                             const selectElement = this.parentElement.querySelector('.status-select');
                             const newStatus = selectElement.value;
                             updateWithdrawalStatus(userId, requestId, newStatus);
                        });
                    });

                })
                .catch(err => {
                    console.error("Error loading withdrawals:", err);
                    tbody.innerHTML = `<tr><td colspan="8">Error loading requests: ${err.message}</td></tr>`;
                    showToast("Failed to load withdrawal requests.", true);
                });
        }

        function loadReferrals() {
            const tbody = document.querySelector('#referralsTable tbody');
            tbody.innerHTML = '<tr><td colspan="4">Loading referrals...</td></tr>';

            database.ref('referralBonuses').once('value')
                .then(snapshot => {
                    tbody.innerHTML = '';
                    const referrals = [];

                    snapshot.forEach(refSnapshot => {
                        const refId = refSnapshot.key;
                        const refData = refSnapshot.val();
                        referrals.push({ refId, ...refData });
                    });

                    if (referrals.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4">No referral bonuses found.</td></tr>';
                        return;
                    }

                    referrals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    referrals.forEach(ref => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ref.referrerId}</td>
                            <td>${ref.refereeId}</td>
                            <td>${parseFloat(ref.amount || 0).toFixed(4)}</td>
                            <td>${formatTimestamp(ref.timestamp)}</td>
                        `;
                        tbody.appendChild(row);
                    });

                })
                .catch(err => {
                    console.error("Error loading referrals:", err);
                    tbody.innerHTML = `<tr><td colspan="4">Error loading referrals: ${err.message}</td></tr>`;
                    showToast("Failed to load referrals.", true);
                });
        }

        function loadDashboardStats() {
             const statTotalUsers = document.getElementById('statTotalUsers');
             const statTotalAdViews = document.getElementById('statTotalAdViews');
             const statTotalReferrals = document.getElementById('statTotalReferrals');
             const statTotalEarnings = document.getElementById('statTotalEarnings');
             const statTotalWithdrawals = document.getElementById('statTotalWithdrawals');

            database.ref('users').once('value').then(snapshot => {
                const count = snapshot.numChildren();
                statTotalUsers.textContent = count;
            }).catch(err => console.error("Error loading user count:", err));

            database.ref('users').once('value').then(snapshot => {
                let totalViews = 0;
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    totalViews += userData.todayStats?.monetagTasksCompleted || 0;
                });
                statTotalAdViews.textContent = totalViews;
            }).catch(err => console.error("Error loading ad view count:", err));

            database.ref('users').once('value').then(snapshot => {
                let totalReferrals = 0;
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    totalReferrals += userData.referralData?.successfulReferrals || 0;
                });
                statTotalReferrals.textContent = totalReferrals;
            }).catch(err => console.error("Error loading referral count:", err));

            database.ref('users').once('value').then(snapshot => {
                let totalEarnings = 0;
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    totalEarnings += parseFloat(userData.userUSDTBalance) || 0;
                });
                statTotalEarnings.textContent = totalEarnings.toFixed(4);
            }).catch(err => console.error("Error loading earnings count:", err));

            database.ref('withdrawals').once('value').then(snapshot => {
                let totalWithdrawals = 0;
                snapshot.forEach(userSnapshot => {
                    userSnapshot.forEach(() => {
                        totalWithdrawals++;
                    });
                });
                statTotalWithdrawals.textContent = totalWithdrawals;
            }).catch(err => console.error("Error loading withdrawal count:", err));
        }

        // --- Action Functions ---
        function toggleUserBlock(userId, block) {
             if (!userId) {
                 showToast("Invalid user ID.", true);
                 return;
             }
            const action = block ? 'block' : 'unblock';
            // Set the value to a strict boolean (true or false)
            database.ref(`users/${userId}/isBlocked`).set(block)
                .then(() => {
                    showToast(`User ${userId} ${action}ed successfully.`);
                    loadUsers(); // Refresh the user list
                })
                .catch(err => {
                    console.error(`Error ${action}ing user ${userId}:`, err);
                    showToast(`Failed to ${action} user.`, true);
                });
        }

        function updateWithdrawalStatus(userId, requestId, newStatus) {
            if (!userId || !requestId || !newStatus) {
                showToast("Invalid request data.", true);
                return;
            }
            database.ref(`withdrawals/${userId}/${requestId}/status`).set(newStatus)
                .then(() => {
                    showToast(`Status for request ${requestId} updated to ${newStatus}.`);
                    loadWithdrawals();
                })
                .catch(err => {
                    console.error(`Error updating status for request ${requestId}:`, err);
                    showToast("Failed to update status.", true);
                });
        }

        // --- Authentication & Initialization ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentAdminUid = user.uid;
                adminUidDisplay.textContent = currentAdminUid;
                console.log("Admin authenticated:", currentAdminUid);

                if (currentAdminUid === ADMIN_UID) {
                    console.log("Correct admin account detected. Loading panel...");
                    loadUsers();
                    loadWithdrawals();
                    loadReferrals();
                    loadSettings();
                    loadDashboardStats();
                    setInterval(loadDashboardStats, 30000);
                } else {
                    console.error("Authenticated user is not the designated admin.");
                    showToast("Access denied. Not the designated admin account.", true);
                }
            } else {
                console.log("Admin not authenticated.");
                showToast("Please log in with the admin account.", true);
            }
        });

        // --- Event Listeners ---
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                showToast("Logged out successfully.");
                window.location.reload();
            }).catch((error) => {
                console.error('Logout error:', error);
                showToast("Logout failed.", true);
            });
        });

        darkModeToggle.addEventListener('click', toggleDarkMode);

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target');
                setActiveSection(target);

                if (target === 'users') loadUsers();
                if (target === 'withdrawals') loadWithdrawals();
                if (target === 'referrals') loadReferrals();
                if (target === 'settings') loadSettings();
                if (target === 'dashboard') loadDashboardStats();
            });
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        document.getElementById('deleteAdminMessageBtn').addEventListener('click', deleteAdminMessage);

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

    </script>
</body>
</html>
